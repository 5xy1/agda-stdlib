<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>README.Debug.Trace</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Comment">------------------------------------------------------------------------</a>
<a id="74" class="Comment">-- The Agda standard library</a>
<a id="103" class="Comment">--</a>
<a id="106" class="Comment">-- An example showing how the Debug.Trace module can be used</a>
<a id="167" class="Comment">------------------------------------------------------------------------</a>

<a id="241" class="Symbol">{-#</a> <a id="245" class="Keyword">OPTIONS</a> <a id="253" class="Pragma">--without-K</a> <a id="265" class="Pragma">--rewriting</a> <a id="277" class="Symbol">#-}</a>

<a id="282" class="Keyword">module</a> <a id="289" href="README.Debug.Trace.html" class="Module">README.Debug.Trace</a> <a id="308" class="Keyword">where</a>

<a id="315" class="Comment">------------------------------------------------------------------------</a>
<a id="388" class="Comment">-- Sometimes compiled code can contain bugs.</a>

<a id="434" class="Comment">-- Whether caused by the compiler or present in the source code already, they</a>
<a id="512" class="Comment">-- can be hard to track. A primitive debugging technique is to strategically</a>
<a id="589" class="Comment">-- insert calls to tracing functions which will display their String argument</a>
<a id="667" class="Comment">-- upon evaluation.</a>

<a id="688" class="Keyword">open</a> <a id="693" class="Keyword">import</a> <a id="700" href="Data.String.Base.html" class="Module">Data.String.Base</a> <a id="717" class="Keyword">using</a> <a id="723" class="Symbol">(</a><a id="724" href="Data.String.Base.html#2559" class="Function Operator">_++_</a><a id="728" class="Symbol">)</a>
<a id="730" class="Keyword">open</a> <a id="735" class="Keyword">import</a> <a id="742" href="Debug.Trace.html" class="Module">Debug.Trace</a>

<a id="755" class="Comment">-- We can for instance add tracing messages to make sure an invariant is</a>
<a id="828" class="Comment">-- respected or check in which order evaluation takes place in the backend</a>
<a id="903" class="Comment">-- (which can inform our decision to use, or not, strictness primitives).</a>

<a id="978" class="Comment">-- In the following example, we define a division operation on natural numbers</a>
<a id="1057" class="Comment">-- using the original dividend as the termination measure. We:</a>

<a id="1121" class="Comment">-- 1. check in the base case that when the fuel runs out then the updated dividend</a>
<a id="1204" class="Comment">--    is already zero.</a>

<a id="1228" class="Comment">-- 2. wrap the calls to _∸_ and go in respective calls to trace to see when all</a>
<a id="1308" class="Comment">--    of these thunks are forced: are we building a big thunk in go&#39;s second</a>
<a id="1385" class="Comment">--    argument or evaluating it as we go?</a>

<a id="1428" class="Keyword">open</a> <a id="1433" class="Keyword">import</a> <a id="1440" href="Data.Maybe.Base.html" class="Module">Data.Maybe.Base</a>
<a id="1456" class="Keyword">open</a> <a id="1461" class="Keyword">import</a> <a id="1468" href="Data.Nat.Base.html" class="Module">Data.Nat.Base</a>
<a id="1482" class="Keyword">open</a> <a id="1487" class="Keyword">import</a> <a id="1494" href="Data.Nat.Show.html" class="Module">Data.Nat.Show</a> <a id="1508" class="Keyword">using</a> <a id="1514" class="Symbol">(</a><a id="1515" href="Data.Nat.Show.html#1928" class="Function">show</a><a id="1519" class="Symbol">)</a>

<a id="div"></a><a id="1522" href="README.Debug.Trace.html#1522" class="Function">div</a> <a id="1526" class="Symbol">:</a> <a id="1528" href="Agda.Builtin.Nat.html#192" class="Datatype">ℕ</a> <a id="1530" class="Symbol">→</a> <a id="1532" href="Agda.Builtin.Nat.html#192" class="Datatype">ℕ</a> <a id="1534" class="Symbol">→</a> <a id="1536" href="Agda.Builtin.Maybe.html#136" class="Datatype">Maybe</a> <a id="1542" href="Agda.Builtin.Nat.html#192" class="Datatype">ℕ</a>
<a id="1544" href="README.Debug.Trace.html#1522" class="Function">div</a> <a id="1548" href="README.Debug.Trace.html#1548" class="Bound">m</a> <a id="1550" href="Agda.Builtin.Nat.html#210" class="InductiveConstructor">zero</a> <a id="1555" class="Symbol">=</a> <a id="1557" href="Agda.Builtin.Maybe.html#195" class="InductiveConstructor">nothing</a>
<a id="1565" href="README.Debug.Trace.html#1522" class="CatchallClause Function">div</a><a id="1568" class="CatchallClause"> </a><a id="1569" href="README.Debug.Trace.html#1569" class="CatchallClause Bound">m</a><a id="1570" class="CatchallClause"> </a><a id="1571" href="README.Debug.Trace.html#1571" class="CatchallClause Bound">n</a>    <a id="1576" class="Symbol">=</a> <a id="1578" href="Agda.Builtin.Maybe.html#174" class="InductiveConstructor">just</a> <a id="1583" class="Symbol">(</a><a id="1584" href="README.Debug.Trace.html#1647" class="Function">go</a> <a id="1587" href="README.Debug.Trace.html#1569" class="Bound">m</a> <a id="1589" href="README.Debug.Trace.html#1569" class="Bound">m</a><a id="1590" class="Symbol">)</a> <a id="1592" class="Keyword">where</a>

  <a id="1601" class="Comment">-- invariants: m ≤ fuel</a>
  <a id="1627" class="Comment">-- result : m / n</a>
  <a id="1647" href="README.Debug.Trace.html#1647" class="Function">go</a> <a id="1650" class="Symbol">:</a> <a id="1652" class="Symbol">(</a><a id="1653" href="README.Debug.Trace.html#1653" class="Bound">fuel</a> <a id="1658" class="Symbol">:</a> <a id="1660" href="Agda.Builtin.Nat.html#192" class="Datatype">ℕ</a><a id="1661" class="Symbol">)</a> <a id="1663" class="Symbol">(</a><a id="1664" href="README.Debug.Trace.html#1664" class="Bound">m</a> <a id="1666" class="Symbol">:</a> <a id="1668" href="Agda.Builtin.Nat.html#192" class="Datatype">ℕ</a><a id="1669" class="Symbol">)</a> <a id="1671" class="Symbol">→</a> <a id="1673" href="Agda.Builtin.Nat.html#192" class="Datatype">ℕ</a>
  <a id="1677" href="README.Debug.Trace.html#1647" class="Function">go</a> <a id="1680" href="Agda.Builtin.Nat.html#210" class="InductiveConstructor">zero</a>       <a id="1691" href="README.Debug.Trace.html#1691" class="Bound">m</a> <a id="1693" class="Symbol">=</a> <a id="1695" href="Debug.Trace.html#476" class="Postulate">trace</a> <a id="1701" class="Symbol">(</a><a id="1702" class="String">&quot;Invariant: &quot;</a> <a id="1716" href="Data.String.Base.html#2559" class="Function Operator">++</a> <a id="1719" href="Data.Nat.Show.html#1928" class="Function">show</a> <a id="1724" href="README.Debug.Trace.html#1691" class="Bound">m</a> <a id="1726" href="Data.String.Base.html#2559" class="Function Operator">++</a> <a id="1729" class="String">&quot; should be zero.&quot;</a><a id="1747" class="Symbol">)</a> <a id="1749" href="Agda.Builtin.Nat.html#210" class="InductiveConstructor">zero</a>
  <a id="1756" href="README.Debug.Trace.html#1647" class="Function">go</a> <a id="1759" class="Symbol">(</a><a id="1760" href="Agda.Builtin.Nat.html#223" class="InductiveConstructor">suc</a> <a id="1764" href="README.Debug.Trace.html#1764" class="Bound">fuel</a><a id="1768" class="Symbol">)</a> <a id="1770" href="README.Debug.Trace.html#1770" class="Bound">m</a> <a id="1772" class="Symbol">=</a>
    <a id="1778" class="Keyword">let</a> <a id="1782" href="README.Debug.Trace.html#1782" class="Bound">m′</a> <a id="1785" class="Symbol">=</a> <a id="1787" href="Debug.Trace.html#476" class="Postulate">trace</a> <a id="1793" class="Symbol">(</a><a id="1794" class="String">&quot;Thunk for step &quot;</a> <a id="1812" href="Data.String.Base.html#2559" class="Function Operator">++</a> <a id="1815" href="Data.Nat.Show.html#1928" class="Function">show</a> <a id="1820" href="README.Debug.Trace.html#1764" class="Bound">fuel</a> <a id="1825" href="Data.String.Base.html#2559" class="Function Operator">++</a> <a id="1828" class="String">&quot; forced&quot;</a><a id="1837" class="Symbol">)</a> <a id="1839" class="Symbol">(</a><a id="1840" href="README.Debug.Trace.html#1770" class="Bound">m</a> <a id="1842" href="Data.Nat.Base.html#2869" class="Primitive Operator">∸</a> <a id="1844" href="README.Debug.Trace.html#1571" class="Bound">n</a><a id="1845" class="Symbol">)</a> <a id="1847" class="Keyword">in</a>
    <a id="1854" href="Debug.Trace.html#476" class="Postulate">trace</a> <a id="1860" class="Symbol">(</a><a id="1861" class="String">&quot;Recursive call for step &quot;</a> <a id="1888" href="Data.String.Base.html#2559" class="Function Operator">++</a> <a id="1891" href="Data.Nat.Show.html#1928" class="Function">show</a> <a id="1896" href="README.Debug.Trace.html#1764" class="Bound">fuel</a><a id="1900" class="Symbol">)</a> <a id="1902" class="Symbol">(</a><a id="1903" href="Agda.Builtin.Nat.html#223" class="InductiveConstructor">suc</a> <a id="1907" class="Symbol">(</a><a id="1908" href="README.Debug.Trace.html#1647" class="Function">go</a> <a id="1911" href="README.Debug.Trace.html#1764" class="Bound">fuel</a> <a id="1916" href="README.Debug.Trace.html#1782" class="Bound">m′</a><a id="1918" class="Symbol">))</a>

<a id="1922" class="Comment">-- To observe the behaviour of this code, we need to compile it and run it.</a>
<a id="1998" class="Comment">-- To run it, we need a main function. We define a very basic one: run div,</a>
<a id="2074" class="Comment">-- and display its result if the run was successful.</a>

<a id="2128" class="Comment">-- We add two calls to trace to see when div is evaluated and when the returned</a>
<a id="2208" class="Comment">-- number is forced (by a call to show).</a>

<a id="2250" class="Keyword">open</a> <a id="2255" class="Keyword">import</a> <a id="2262" href="Level.html" class="Module">Level</a> <a id="2268" class="Keyword">using</a> <a id="2274" class="Symbol">(</a><a id="2275" href="Level.html#512" class="Function">0ℓ</a><a id="2277" class="Symbol">)</a>
<a id="2279" class="Keyword">open</a> <a id="2284" class="Keyword">import</a> <a id="2291" href="IO.html" class="Module">IO</a>

<a id="main"></a><a id="2295" href="README.Debug.Trace.html#2295" class="Function">main</a> <a id="2300" class="Symbol">=</a>
  <a id="2304" class="Keyword">let</a> <a id="2308" href="README.Debug.Trace.html#2308" class="Bound">r</a> <a id="2310" class="Symbol">=</a> <a id="2312" href="Debug.Trace.html#476" class="Postulate">trace</a> <a id="2318" class="String">&quot;Call to div&quot;</a> <a id="2332" class="Symbol">(</a><a id="2333" href="README.Debug.Trace.html#1522" class="Function">div</a> <a id="2337" class="Number">4</a> <a id="2339" class="Number">2</a><a id="2340" class="Symbol">)</a>
      <a id="2348" href="README.Debug.Trace.html#2348" class="Bound">j</a> <a id="2350" class="Symbol">=</a> <a id="2352" class="Symbol">λ</a> <a id="2354" href="README.Debug.Trace.html#2354" class="Bound">n</a> <a id="2356" class="Symbol">→</a> <a id="2358" href="Debug.Trace.html#476" class="Postulate">trace</a> <a id="2364" class="String">&quot;Forcing the result wrapped in just.&quot;</a> <a id="2402" class="Symbol">(</a><a id="2403" href="IO.html#4913" class="Function">putStrLn</a> <a id="2412" class="Symbol">(</a><a id="2413" href="Data.Nat.Show.html#1928" class="Function">show</a> <a id="2418" href="README.Debug.Trace.html#2354" class="Bound">n</a><a id="2419" class="Symbol">))</a> <a id="2422" class="Keyword">in</a>
  <a id="2427" href="IO.html#1614" class="Function">run</a> <a id="2431" class="Symbol">{</a><a id="2432" class="Argument">a</a> <a id="2434" class="Symbol">=</a> <a id="2436" href="Level.html#512" class="Function">0ℓ</a><a id="2438" class="Symbol">}</a> <a id="2440" class="Symbol">(</a><a id="2441" href="Data.Maybe.Base.html#1554" class="Function">maybe′</a> <a id="2448" href="README.Debug.Trace.html#2348" class="Bound">j</a> <a id="2450" class="Symbol">(</a><a id="2451" href="IO.html#1030" class="InductiveConstructor">return</a> <a id="2458" class="Symbol">_)</a> <a id="2461" href="README.Debug.Trace.html#2308" class="Bound">r</a><a id="2462" class="Symbol">)</a>

<a id="2465" class="Comment">-- We get the following trace where we can see that checking that the</a>
<a id="2535" class="Comment">-- maybe-solution is just-headed does not force the natural number. Once forced,</a>
<a id="2616" class="Comment">-- we observe that we indeed build a big thunk on go&#39;s second argument (all the</a>
<a id="2696" class="Comment">-- recursive calls happen first and then we force the thunks one by one).</a>

<a id="2771" class="Comment">-- Call to div</a>
<a id="2786" class="Comment">-- Forcing the result wrapped in just.</a>
<a id="2825" class="Comment">-- Recursive call for step 3</a>
<a id="2854" class="Comment">-- Recursive call for step 2</a>
<a id="2883" class="Comment">-- Recursive call for step 1</a>
<a id="2912" class="Comment">-- Recursive call for step 0</a>
<a id="2941" class="Comment">-- Thunk for step 0 forced</a>
<a id="2968" class="Comment">-- Thunk for step 1 forced</a>
<a id="2995" class="Comment">-- Thunk for step 2 forced</a>
<a id="3022" class="Comment">-- Thunk for step 3 forced</a>
<a id="3049" class="Comment">-- Invariant: 0 should be zero.</a>
<a id="3081" class="Comment">-- 4</a>

<a id="3087" class="Comment">-- We also notice that the result is incorrect: 4/2 is 2 and not 4. We quickly</a>
<a id="3166" class="Comment">-- notice that (div m (suc n)) will perform m recursive calls no matter what.</a>
<a id="3244" class="Comment">-- And at each call it will put add 1. We can fix this bug by adding a new first</a>
<a id="3325" class="Comment">-- equation to go:</a>

<a id="3345" class="Comment">-- go fuel zero = zero</a>

<a id="3369" class="Comment">-- Running the example again we observe that because we now need to check</a>
<a id="3443" class="Comment">-- whether go&#39;s second argument is zero, the function is more strict: we see</a>
<a id="3520" class="Comment">-- that recursive calls and thunk forcings are interleaved.</a>

<a id="3581" class="Comment">-- Call to div</a>
<a id="3596" class="Comment">-- Forcing the result wrapped in just.</a>
<a id="3635" class="Comment">-- Recursive call for step 3</a>
<a id="3664" class="Comment">-- Thunk for step 3 forced</a>
<a id="3691" class="Comment">-- Recursive call for step 2</a>
<a id="3720" class="Comment">-- Thunk for step 2 forced</a>
<a id="3747" class="Comment">-- 2</a>
</pre></body></html>